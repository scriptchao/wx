<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<style>
    body {
        font-size: 40px;
        line-height: 2
    }

    .btn {
        color: rgb(249, 38, 144);
        text-decoration: underline;
    }

    .hide {
        display: none;
    }
</style>
<script src="./jquery-2.2.3.min.js"></script>
<script src="./weChat.js"></script>
<script>

    const weChat = new WeChat('test_token');

    if (localStorage.getItem(weChat.getToken())) {
        weChat.getUserInfo().then(response => {
            if (response.result) {

                const data = response.data;
                const info = document.getElementById('info');
                const ul = document.createElement('ul');

                $(ul).append(`<li><label for="">姓名 </label><span>${data.nickname}</span></li>`)
                    .append(`<li><label for="">性别 </label><span>${data.sex == 1 ? '男' : '女'}</span></li>`)
                    .append(`<li><label for="">所在地 </label><span>${`${data.province} ${data.city}`}</span></li>`)
                    .appendTo(info)

            } else {
                localStorage.removeItem(weChat.getToken());
                location.reload()
            }
        })
    } else {
        weChat.redirect('/test/auth.html')
    }

</script>
<body>
<div id="info"></div>
<div onclick="getNetworkType()" class="btn">获取网络状态</div>
<span id="tip2"></span>
<div onclick="getLocation()" class="btn">获取经纬度</div>
<span id="tip3"></span><br/>
<span id="tip4"></span>
<div onclick="getAddress()" class="btn">获取具体位置</div>
<span id="tip5"></span>
<div id="allmap" style="width:600px;height:600px"></div>
<div onclick="chooseImage()" id="chooseImage" class="btn">拍照或从手机相册中选图6</div>
<img src="" id="img1"/>
<div onclick="uploadImage()" class="btn">上传图片</div>
<span class="hide" id="tip1">上传成功，请点击下载图片</span>
<div onclick="downloadImage()" class="btn">下载图片</div>
<img src="" id="img2"/>


</body>
<script src="http://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>
<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=mn2r7dXd88cGufeDCQgQafZhIZGSuFVo"></script>
<script>

    weChat.sign({
        title: '小马哥!',
        desc: '老夫警告你 别跟我老资格哦!',
        link: '',
        imgUrl: 'http://scriptchao.viphk.ngrok.org/static/img/a.jpg',
    });
    weChat.setClose()
</script>
<script>
    let localId, serverId, networkType, latitude, longitude;
    function chooseImage() {
        wx.chooseImage({
            count: 1, // 默认9
            sizeType: ['original', 'compressed'], // 可以指定是原图还是压缩图，默认二者都有
            sourceType: ['album', 'camera'], // 可以指定来源是相册还是相机，默认二者都有
            success: function (res) {
                localId = res.localIds[0]; // 返回选定照片的本地ID列表，localId可以作为img标签的src属性显示图片
                $('#img1').attr('src', localId)
            }
        });

    }

    function uploadImage() {

        wx.uploadImage({
            localId: localId, // 需要上传的图片的本地ID，由chooseImage接口获得
            isShowProgressTips: 1, // 默认为1，显示进度提示
            success: function (res) {
                serverId = res.serverId; // 返回图片的服务器端ID
                $('#tip1').removeClass('hide')
            }
        });
    }

    function downloadImage() {
        wx.downloadImage({
            serverId: serverId, // 需要下载的图片的服务器端ID，由uploadImage接口获得
            isShowProgressTips: 1, // 默认为1，显示进度提示
            success: function (res) {
                localId = res.localId; // 返回图片下载后的本地ID
                $('#img2').attr('src', localId)
            }
        });
    }

    function getNetworkType() {
        wx.getNetworkType({
            success: function (res) {
                networkType = res.networkType; // 返回网络类型2g，3g，4g，wifi
                $('#tip2').text(networkType)
            }
        });
    }

    function getLocation() {
        wx.getLocation({
            type: 'wgs84', // 默认为wgs84的gps坐标，如果要返回直接给openLocation用的火星坐标，可传入'gcj02'
            success: function (res) {
                latitude = res.latitude; // 纬度，浮点数，范围为90 ~ -90
                longitude = res.longitude; // 经度，浮点数，范围为180 ~ -180。
                $('#tip3').text(`经度 ：${longitude}`);
                $('#tip4').text(`纬度 ：${latitude}`);
            }
        });
    }


    function getAddress() {
        $.ajax({
            url: '/wx/map',
            type: 'get',
            data: {
                longitude: longitude,
                latitude: latitude
            }
        }).then(response => {
            let {x, y} = response.data;

            let address;
            let map = new BMap.Map("allmap");
            let point = new BMap.Point(x, y);
            let marker = new BMap.Marker(point);
            map.centerAndZoom(point, 12);
            map.enableScrollWheelZoom(true);
            map.addOverlay(marker);
            let gc = new BMap.Geocoder();
            gc.getLocation(point, function (rs) {
                console.log(rs);
                let addComp = rs.addressComponents;
                if (rs.business) {
                    address = `${addComp.province} ${addComp.city} ${addComp.district} ${rs.business}`
                } else {
                    address = `${addComp.province} ${addComp.city} ${addComp.district} ${addComp.street} ${addComp.streetNumber}`
                }
                $('#tip5').text(address)
            });
        })
    }
</script>
</html>